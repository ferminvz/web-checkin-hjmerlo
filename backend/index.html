<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Web Check-in Howard Johnson</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    
    <!-- ZXing para lectura de PDF417 -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/zxing-browser.min.js"></script>
        
    <!-- Tesseract.js para OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    
    <!-- Signature Pad para captura de firma -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <style>
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        #signatureCanvas {
            width: 100%;
            height: 200px;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #fff;
            cursor: crosshair;
        }
        .progress-step {
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            background-color: #e5e7eb;
            color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            z-index: 10;
            position: relative;
        }
        .progress-step.active {
            background-color: #3b82f6;
            color: white;
        }
        .progress-step.completed {
            background-color: #10b981;
            color: white;
        }
        .progress-line {
            height: 2px;
            background-color: #e5e7eb;
            flex: 1;
        }
        .progress-line-completed {
            height: 2px;
            background-color: #10b981;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: width 0.5s ease;
        }
        .drop-area {
            @apply border-2 border-dashed border-gray-300 rounded-lg p-6 text-center transition-colors min-h-[200px] flex flex-col items-center justify-center relative;
            background-image: repeating-linear-gradient(45deg, #f0f0f0 0px, #f0f0f0 10px, transparent 10px, transparent 20px);
            background-size: 28px 28px;
        }
        .drop-area:hover {
            @apply border-blue-500;
            background-image: repeating-linear-gradient(45deg, #ebf5ff 0px, #ebf5ff 10px, transparent 10px, transparent 20px);
        }
        .drop-area.drag {
            @apply border-blue-500;
            background-image: repeating-linear-gradient(45deg, #ebf5ff 0px, #ebf5ff 10px, transparent 10px, transparent 20px);
        }
        .preview-area {
            @apply mt-4 min-h-[200px] flex items-center justify-center bg-gray-50 rounded-lg overflow-hidden;
        }
        .preview-area img {
            @apply max-h-48 object-contain;
        }
        @media (max-width: 640px) {
            .container {
                @apply px-2;
            }
            .drop-area {
                @apply p-3;
            }
            .preview-area {
                @apply min-h-[150px];
            }
            .preview-area img {
                @apply max-h-36;
            }
        }
        .header-background {
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 2rem 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(1px);
        }
        .header-content {
            position: relative;
            z-index: 10;
        }
        .logo-container {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: inline-block;
            margin-bottom: 1rem;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 50;
            transition: opacity 0.3s ease-in-out;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="min-h-screen w-full">
        <div class="container mx-auto px-4 py-8 max-w-3xl">
            <!-- Header con Logo y T√≠tulo -->
            <header class="header-background mb-6 relative">
                <img src="/public/images/hotel-bg.jpg" alt="Piscina del hotel" class="w-full h-40 object-cover object-center blur-sm select-none pointer-events-none absolute inset-0"/>
                <div class="header-overlay"></div>
                <div class="header-content">
                    <div class="logo-container">
                        <img src="/public/images/logo.png" alt="Logo Howard Johnson" class="h-14"/>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-center text-blue-800 mb-2">Web Check-in HJ Merlo</h1>
                    <p class="text-center text-gray-600 text-sm">Complete el formulario para agilizar su proceso de registro</p>

                    <!-- Barra de Progreso -->
                    <div class="mt-8">
                        <div class="flex items-center justify-between relative">
                            <div id="progressBar" class="progress-line-completed absolute" style="width: 0%;"></div>
                            <div class="progress-step active" data-step="1">1</div>
                            <div class="progress-line"></div>
                            <div class="progress-step" data-step="2">2</div>
                            <div class="progress-line"></div>
                            <div class="progress-step" data-step="3">3</div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                            <div>Documentos</div>
                            <div>Acompa√±antes</div>
                            <div>Finalizar</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Formulario Principal -->
            <form id="checkInForm" class="bg-white rounded-lg shadow-md p-6 relative">
                <!-- Indicador de carga -->
                <div id="loadingIndicator" class="hidden absolute inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
                    <div class="text-center">
                        <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p id="loadingText" class="text-sm text-blue-600 font-medium mt-2">Procesando...</p>
                    </div>
                </div>

                <!-- Secci√≥n 1: Documentos y Datos Personales -->
                <div id="section1" class="section active space-y-6">
                    <h2 class="text-xl font-semibold text-blue-800 mb-6">Documento y datos del titular</h2>

                    <!-- Tipo de Documento -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="documentType">
                            Tipo de Documento
                        </label>
                        <select id="documentType" name="documentType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Seleccione un tipo</option>
                            <option value="dni" selected>DNI (Argentina)</option>
                            <option value="passport">Pasaporte</option>
                            <option value="foreign_id">Documento Extranjero</option>
                        </select>
                        <p class="text-red-500 text-xs mt-1 hidden" data-error-for="documentType">Seleccione un tipo de documento.</p>
                    </div>

                    <!-- Documentos -->
                    <div class="grid sm:grid-cols-2 gap-6">
                        <!-- Frente del Documento -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="documentFront">
                                Frente (PDF-417)
                            </label>
                            <div id="dropFront" class="drop-area relative">
                                <input type="file" id="documentFront" name="documentFront" class="hidden" accept="image/*" capture="environment" required>
                                <div class="flex flex-col items-center">
                                    <div class="flex flex-col sm:flex-row gap-4 mb-4 w-full justify-center">
                                        <button type="button" class="upload-file-btn w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition" data-target="documentFront">
                                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            Subir Archivo
                                        </button>
                                        <button type="button" class="camera-btn w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition" data-target="documentFront">
                                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                            Usar C√°mara
                                        </button>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-600" id="frontFileName">Click o arrastre archivo</p>
                                    <div id="frontPreview" class="preview-area">
                                        <span class="text-gray-500">Vista previa del frente</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dorso del Documento -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="documentBack">
                                Dorso (OCR)
                            </label>
                            <div id="dropBack" class="drop-area relative">
                                <input type="file" id="documentBack" name="documentBack" class="hidden" accept="image/*" capture="environment" required>
                                <div class="flex flex-col items-center">
                                    <div class="flex flex-col sm:flex-row gap-4 mb-4 w-full justify-center">
                                        <button type="button" class="upload-file-btn w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition" data-target="documentBack">
                                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            Subir Archivo
                                        </button>
                                        <button type="button" class="camera-btn w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition" data-target="documentBack">
                                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                            Usar C√°mara
                                        </button>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-600" id="backFileName">Click o arrastre archivo</p>
                                    <div id="backPreview" class="preview-area">
                                        <span class="text-gray-500">Vista previa del dorso</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos Personales -->
                    <div class="grid sm:grid-cols-2 gap-4 mt-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="firstName">
                                Nombre *
                            </label>
                            <input type="text" id="firstName" name="firstName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="firstName">El nombre es requerido.</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="lastName">
                                Apellido *
                            </label>
                            <input type="text" id="lastName" name="lastName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="lastName">El apellido es requerido.</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="documentNumber">
                                N¬∫ documento *
                            </label>
                            <input type="text" id="documentNumber" name="documentNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="documentNumber">El n√∫mero de documento es requerido.</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="birthDate">
                                Fecha de Nacimiento *
                            </label>
                            <input type="date" id="birthDate" name="birthDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="birthDate">La fecha de nacimiento es requerida.</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
                                Email *
                            </label>
                            <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="email">El email es requerido y debe ser v√°lido.</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="whatsapp">
                                WhatsApp *
                            </label>
                            <div class="relative flex">
                                <input type="text" 
                                       id="whatsappPrefix" 
                                       class="flex-none w-20 px-2 py-2 border border-r-0 border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50" 
                                       value="+549"
                                       placeholder="+XXX">
                                <div class="flex-1 relative">
                                    <input type="tel" 
                                           id="whatsappNumber" 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="N√∫mero sin prefijo"
                                           maxlength="15"
                                           required
                                           oninput="validateWhatsApp(this)">
                                    <!-- Campo oculto que contendr√° el n√∫mero completo -->
                                    <input type="hidden" 
                                           id="whatsapp" 
                                           name="whatsapp" 
                                           required>
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <svg class="whatsapp-check hidden h-5 w-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <svg class="whatsapp-error hidden h-5 w-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="whatsapp">Ingrese un n√∫mero de WhatsApp v√°lido</p>
                            <p class="text-gray-500 text-xs mt-1">Ejemplos: +549 1123456789 (Argentina) o +1 555-123-4567 (USA)</p>
                        </div>
                        <div class="col-span-full">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="address">
                                Direcci√≥n
                            </label>
                            <input type="text" id="address" name="address" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="address">La direcci√≥n es requerida.</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="city">
                                Localidad
                            </label>
                            <div class="relative">
                                <input type="text" id="city" name="city" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required autocomplete="off">
                                <div id="citySuggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-100 max-h-60 overflow-y-auto hidden"></div>
                            </div>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="city">La localidad es requerida.</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="province">
                                Provincia
                            </label>
                            <input type="text" id="province" name="province" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50" readonly>
                        </div>
                        <div id="countryField" class="hidden">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="country">
                                Pa√≠s
                            </label>
                            <input type="text" id="country" name="country" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-red-500 text-xs mt-1 hidden" data-error-for="country">El pa√≠s es requerido.</p>
                        </div>
                    </div>

                    <!-- Datos del Veh√≠culo -->
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="carBrand">
                                Marca del Veh√≠culo (opcional)
                            </label>
                            <input type="text" id="carBrand" name="carBrand" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="licensePlate">
                                Patente (opcional)
                            </label>
                            <input type="text" id="licensePlate" name="licensePlate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Firma -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Firma *
                        </label>
                        <div class="border rounded-lg bg-white p-2">
                            <canvas id="signatureCanvas"></canvas>
                            <p id="signatureError" class="hidden text-red-500 text-sm mt-1">Por favor, firme en el √°rea designada</p>
                            <div class="flex justify-end mt-2">
                                <button type="button" id="clearSignature" class="text-sm text-blue-600 hover:text-blue-800 focus:outline-none">
                                    Limpiar firma
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de navegaci√≥n -->
                    <div class="flex justify-end mt-8">
                        <button type="button" id="btnNext1" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                            Siguiente
                        </button>
                    </div>
                </div>

                <!-- Secci√≥n 2: Acompa√±antes -->
                <div id="section2" class="section space-y-6">
                    <h2 class="text-xl font-semibold text-blue-800 mb-6">Acompa√±antes</h2>

                    <!-- Acompa√±ante Adulto -->
                    <fieldset class="space-y-4">
                        <legend class="block text-gray-700 text-sm font-bold mb-2">
                            ¬øViaja con acompa√±ante adulto?
                        </legend>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="adultCompanion" value="si" class="form-radio">
                                <span class="ml-2">S√≠</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="adultCompanion" value="no" class="form-radio" checked>
                                <span class="ml-2">No</span>
                            </label>
                        </div>
                    </fieldset>

                    <!-- Campos de Acompa√±ante Adulto -->
                    <div id="adultFields" class="hidden grid sm:grid-cols-2 gap-4 mt-4 p-4 border rounded">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="adultLastName">
                                Apellido
                            </label>
                            <input type="text" id="adultLastName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="adultFirstName">
                                Nombre
                            </label>
                            <input type="text" id="adultFirstName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="adultDNI">
                                DNI
                            </label>
                            <input type="text" id="adultDNI" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="adultWhatsapp">
                                Whatsapp
                            </label>
                            <input type="tel" id="adultWhatsapp" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="+549XXXXXXXXXX">
                        </div>
                        <div class="col-span-full">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="adultEmail">
                                Email
                            </label>
                            <input type="email" id="adultEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Acompa√±antes Menores -->
                    <fieldset class="space-y-4 mt-6">
                        <legend class="block text-gray-700 text-sm font-bold mb-2">
                            ¬øViaja con menores?
                        </legend>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="minorCompanions" value="si" class="form-radio">
                                <span class="ml-2">S√≠</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="minorCompanions" value="no" class="form-radio" checked>
                                <span class="ml-2">No</span>
                            </label>
                        </div>
                    </fieldset>

                    <!-- Campos de Menores -->
                    <div id="minorFields" class="hidden space-y-6 mt-4"></div>

                    <!-- Botones de navegaci√≥n -->
                    <div class="flex justify-between mt-8">
                        <button type="button" id="btnPrev2" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                            Anterior
                        </button>
                        <button type="button" id="btnNext2" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                            Siguiente
                        </button>
                    </div>
                </div>

                <!-- Secci√≥n 3: Resumen -->
                <div id="section3" class="section space-y-6">
                    <h2 class="text-xl font-semibold text-blue-800 mb-6">Resumen</h2>
                    
                    <div id="resume" class="bg-gray-50 p-4 rounded border space-y-4">
                        <div>
                            <h3 class="font-semibold mb-2">Datos del Titular</h3>
                            <div class="grid sm:grid-cols-2 gap-2 text-sm">
                                <div>
                                    <span class="font-medium text-gray-600">Nombre:</span>
                                    <span id="resumen-nombre">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Apellido:</span>
                                    <span id="resumen-apellido">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Documento:</span>
                                    <span id="resumen-documento">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Fecha Nac.:</span>
                                    <span id="resumen-nacimiento">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Email:</span>
                                    <span id="resumen-email">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">WhatsApp:</span>
                                    <span id="resumen-whatsapp">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Direcci√≥n:</span>
                                    <span id="resumen-direccion">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Localidad:</span>
                                    <span id="resumen-localidad">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Provincia:</span>
                                    <span id="resumen-provincia">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Veh√≠culo:</span>
                                    <span id="resumen-marca">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Patente:</span>
                                    <span id="resumen-patente">-</span>
                                </div>
                            </div>
                        </div>

                        <div id="summaryAdultCompanion" class="hidden">
                            <h3 class="font-semibold mb-2">Acompa√±ante Adulto</h3>
                            <div class="grid sm:grid-cols-2 gap-2 text-sm">
                                <div>
                                    <span class="font-medium text-gray-600">Nombre:</span>
                                    <span id="summaryAdultName">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Documento:</span>
                                    <span id="summaryAdultDocument">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">WhatsApp:</span>
                                    <span id="summaryAdultWhatsapp">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Email:</span>
                                    <span id="summaryAdultEmail">-</span>
                                </div>
                            </div>
                        </div>

                        <div id="summaryMinorCompanions" class="hidden">
                            <h3 class="font-semibold mb-2">Acompa√±antes Menores</h3>
                            <div class="divide-y" id="minorsResumen"></div>
                        </div>
                    </div>

                    <!-- Botones de navegaci√≥n -->
                    <div class="flex justify-between mt-8">
                        <button type="button" id="btnPrev3" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                            Anterior
                        </button>
                        <button type="submit" id="btnSubmit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition">
                            Completar Check-in
                        </button>
                    </div>
                </div>
            </form>

            <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mt-6" role="alert">
                <strong class="font-bold">¬°Check-in completado!</strong>
                <span class="block sm:inline"> Sus datos han sido enviados correctamente. ¬°Gracias por elegirnos!</span>
            </div>
        </div>
    </div>

    <!-- Template Menor -->
    <template id="minorTemplate">
        <div class="grid sm:grid-cols-2 gap-4 p-4 border rounded relative">
            <span class="absolute -top-3 left-3 bg-gray-100 text-xs px-2 py-px rounded text-gray-600">
                Menor <span class="minorIndex"></span>
            </span>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    Nombre
                </label>
                <input type="text" class="minor-first w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    Apellido
                </label>
                <input type="text" class="minor-last w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    Fecha de Nacimiento
                </label>
                <input type="date" class="minor-birth w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    DNI
                </label>
                <input type="text" class="minor-dni w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </template>

    <script>
        // Clase para manejar el historial de b√∫squedas
        class SearchHistory {
            static get() {
                try {
                    const history = localStorage.getItem('searchHistory');
                    return history ? JSON.parse(history) : [];
                } catch (error) {
                    console.error('Error al leer historial:', error);
                    return [];
                }
            }

            static add(item) {
                try {
                    const history = this.get();
                    // Evitar duplicados
                    const exists = history.some(h => 
                        h.ciudad === item.ciudad && h.provincia === item.provincia
                    );
                    if (!exists) {
                        history.unshift(item);
                        // Mantener solo las √∫ltimas 5 b√∫squedas
                        if (history.length > 5) history.pop();
                        localStorage.setItem('searchHistory', JSON.stringify(history));
                    }
                } catch (error) {
                    console.error('Error al guardar en historial:', error);
                }
            }

            static clear() {
                try {
                    localStorage.removeItem('searchHistory');
                    showHistory(); // Actualizar la UI
                } catch (error) {
                    console.error('Error al limpiar historial:', error);
                }
            }
        }

        // Funciones globales necesarias
        function showNotification(message, type = 'info', duration = 3000) {
            // Eliminar notificaciones existentes
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Crear nueva notificaci√≥n
            const notification = document.createElement('div');
            notification.className = `toast ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 
                type === 'warning' ? 'bg-yellow-500' :
                'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animaci√≥n de entrada
            notification.style.opacity = '0';
            setTimeout(() => notification.style.opacity = '1', 10);
            
            // Eliminar despu√©s del tiempo especificado
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Funciones auxiliares de canvas
        function createCanvas(width, height) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            return canvas;
        }

        function scaleImage(img, maxDimension) {
            const ratio = Math.min(1, maxDimension / Math.max(img.naturalWidth, img.naturalHeight));
            if (ratio === 1) return img;
            
            const canvas = createCanvas(img.naturalWidth * ratio, img.naturalHeight * ratio);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            return canvas;
        }

        function cropImage(src, x, y, w, h) {
            const canvas = createCanvas(src.width * w, src.height * h);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(
                src,
                src.width * x, src.height * y, src.width * w, src.height * h,
                0, 0, canvas.width, canvas.height
            );
            return canvas;
        }

        function padImage(src, padding) {
            const canvas = createCanvas(src.width + padding * 2, src.height + padding * 2);
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(src, padding, padding);
            return canvas;
        }

        function rotateImage(src, degrees) {
            if (!degrees) return src;
            
            const canvas = createCanvas(
                degrees % 180 ? src.height : src.width,
                degrees % 180 ? src.width : src.height
            );
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(degrees * Math.PI / 180);
            ctx.drawImage(src, -src.width / 2, -src.height / 2);
            return canvas;
        }

        // Procesamiento de PDF417
        async function decodePDF417(img) {
            console.log("üîç Iniciando decodificaci√≥n PDF417 mejorada");
            
            try {
                // 1) Intentar leer directamente de la imagen completa
                try {
                    const result = await state.zxingReader.decodeFromImageElement(img);
                    console.log("‚úÖ PDF417 detectado en imagen completa");
                    return result.text;
                } catch (e) {
                    console.debug('PDF-417 no detectado en imagen completa, probando recortes...', e);
                }

                // 2) Intentar con recorte espec√≠fico de la zona del PDF417
                const scaled = scaleImage(img, 1200);
                let preprocess = padImage(cropImage(scaled, 0.60, 0.65, 0.38, 0.30), 12);
                
                // Probar en diferentes rotaciones
                for (let degrees of [0, 90, 180, 270]) {
                    try {
                        const rotated = rotateImage(preprocess, degrees);
                        const result = await state.zxingReader.decodeFromCanvas(rotated);
                        console.log(`‚úÖ PDF417 detectado en recorte con rotaci√≥n ${degrees}¬∞`);
                        return result.text;
                    } catch (e) {
                        console.debug(`Intento fallido con rotaci√≥n ${degrees}¬∞`);
                    }
                }

                // 3) Intentar con un recorte ampliado
                preprocess = padImage(cropImage(scaled, 0.55, 0.60, 0.45, 0.35), 12);
                
                // Probar en diferentes rotaciones con el recorte ampliado
                for (let degrees of [0, 90, 180, 270]) {
                    try {
                        const rotated = rotateImage(preprocess, degrees);
                        const result = await state.zxingReader.decodeFromCanvas(rotated);
                        console.log(`‚úÖ PDF417 detectado en recorte ampliado con rotaci√≥n ${degrees}¬∞`);
                        return result.text;
                    } catch (e) {
                        console.debug(`Intento fallido con recorte ampliado y rotaci√≥n ${degrees}¬∞`);
                    }
                }

                throw new Error("No se pudo decodificar el PDF417 tras m√∫ltiples intentos");
            } catch (error) {
                console.error("‚ùå Error en decodificaci√≥n PDF417:", error);
                throw error;
            }
        }

        // OCR 
        async function tryOCR(imageElement) {
            console.log("üîç Iniciando OCR");
            try {
                if (!window.state.tesseractWorker) {
                    console.log("üìö Inicializando Tesseract");
                    window.state.tesseractWorker = await Tesseract.createWorker();
                    await window.state.tesseractWorker.loadLanguage('spa');
                    await window.state.tesseractWorker.initialize('spa');
                    // Configuraci√≥n optimizada para documentos
                    await window.state.tesseractWorker.setParameters({
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMN√ëOPQRSTUVWXYZabcdefghijklmn√±opqrstuvwxyz0123456789.,- ',
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO_OSD,
                        preserve_interword_spaces: '1'
                    });
                }

                // Preparar imagen
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Redimensionar si es necesario
                let width = imageElement.naturalWidth || imageElement.width;
                let height = imageElement.naturalHeight || imageElement.height;
                const maxDimension = 1200;
                
                if (width > maxDimension || height > maxDimension) {
                    if (width > height) {
                        height = Math.round((height * maxDimension) / width);
                        width = maxDimension;
                    } else {
                        width = Math.round((width * maxDimension) / height);
                        height = maxDimension;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Dibujar imagen
                ctx.drawImage(imageElement, 0, 0, width, height);
                
                // Mejorar contraste para OCR
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    // Aumentar contraste para OCR
                    const value = avg < 128 ? 0 : 255;
                    data[i] = data[i + 1] = data[i + 2] = value;
                }
                
                ctx.putImageData(imageData, 0, 0);

                // Ejecutar OCR
                const result = await window.state.tesseractWorker.recognize(canvas);
                console.log("üìù Texto extra√≠do por OCR:", result.data.text);

                return result.data.text;
            } catch (error) {
                console.error("‚ùå Error en OCR:", error);
                throw error;
            }
        }

        // Funci√≥n para procesar documento frontal
        async function processDocumentFront(file) {
            if (!file) {
                console.warn('No se proporcion√≥ archivo para procesar');
                return;
            }
            
            console.log('Iniciando procesamiento del frente del documento:', file.name);
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('loadingText').textContent = 'Procesando documento...';
            
            try {
                const img = new Image();
                const imgUrl = URL.createObjectURL(file);
                img.src = imgUrl;
                
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = () => reject(new Error('Error al cargar la imagen'));
                });
                
                console.log('Imagen cargada, intentando decodificar PDF417');
                
                try {
                    // Intenta decodificar PDF417
                    const rawText = await decodePDF417(img);
                    console.log('Resultado PDF417:', rawText ? 'Exitoso' : 'Fallido');
                    
                    if (rawText) {
                        const data = parsePDF417Data(rawText);
                        if (data) {
                            console.log('Datos extra√≠dos del PDF417:', data);
                            populateFormWithData(data);
                            showNotification('PDF-417 le√≠do correctamente', 'success');
                        } else {
                            throw new Error('No se pudieron extraer datos del PDF-417');
                        }
                    } else {
                        throw new Error('Decodificaci√≥n PDF417 fallida');
                    }
                } catch (pdfError) {
                    console.warn('PDF-417 fall√≥, usando OCR', pdfError);
                    
                    // Intenta OCR si PDF417 falla
                    const ocrText = await tryOCR(img);
                    console.log('Resultado OCR:', ocrText ? 'Exitoso' : 'Fallido');
                    
                    if (ocrText) {
                        const data = parseOCRData(ocrText);
                        if (data) {
                            console.log('Datos extra√≠dos por OCR:', data);
                            populateFormWithData(data);
                            showNotification('Datos extra√≠dos por OCR', 'success');
                        } else {
                            throw new Error('No se pudieron extraer datos por OCR');
                        }
                    } else {
                        throw new Error('OCR fall√≥');
                    }
                }
                
                URL.revokeObjectURL(imgUrl);
            } catch (error) {
                console.error('Error al procesar el frente del documento:', error);
                showNotification('Error al procesar el documento: ' + error.message, 'error');
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        // Funci√≥n para procesar dorso del documento
        async function processDocumentBack(file) {
            if (!file) return;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('loadingText').textContent = 'Procesando dorso del documento...';
            
            try {
                const img = new Image();
                const imgUrl = URL.createObjectURL(file);
                img.src = imgUrl;
                
                await new Promise(resolve => { img.onload = resolve; });
                
                // Solo mostrar la vista previa de la imagen
                showNotification('Imagen del dorso del documento cargada correctamente', 'success');
                
                URL.revokeObjectURL(imgUrl);
            } catch (error) {
                console.error('Error al procesar el dorso del documento:', error);
                showNotification('Error al procesar el documento', 'error');
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        // Funciones de formato
        function formatToTitleCase(text) {
            if (!text) return '';
            return text.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        function formatToSentenceCase(text) {
            if (!text) return '';
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        // Funci√≥n para analizar datos OCR
        function parseOCRData(text) {
            console.log("üîç Analizando texto OCR para datos personales");
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const data = {};

            // Buscar nombre y apellido
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toUpperCase();
                
                if (line.includes('APELLIDO') || line.includes('SURNAME')) {
                    for (let j = i + 1; j < Math.min(i + 3, lines.length); j++) {
                        const possibleLastName = lines[j].trim();
                        if (possibleLastName && !possibleLastName.includes('NOMBRE') && !possibleLastName.includes('NAME')) {
                            data.apellido = formatToTitleCase(possibleLastName);
                            console.log("üìù Apellido encontrado:", data.apellido);
                            break;
                        }
                    }
                }
                
                if (line.includes('NOMBRE') || line.includes('NAME')) {
                    for (let j = i + 1; j < Math.min(i + 3, lines.length); j++) {
                        const possibleName = lines[j].trim();
                        if (possibleName && !possibleName.includes('APELLIDO') && !possibleName.includes('SURNAME')) {
                            data.nombre = formatToTitleCase(possibleName);
                            console.log("üìù Nombre encontrado:", data.nombre);
                            break;
                        }
                    }
                }
            }

            // Buscar n√∫mero de documento
            const docMatch = text.match(/\b\d{7,8}\b/);
            if (docMatch) {
                data.numeroDocumento = docMatch[0];
                console.log("üìù N√∫mero de documento encontrado:", data.numeroDocumento);
            }

            // Buscar fecha de nacimiento
            const dateMatch = text.match(/\b\d{1,2}[\/-]\d{1,2}[\/-]\d{4}\b/);
            if (dateMatch) {
                data.fechaNacimiento = dateMatch[0];
                console.log("üìù Fecha de nacimiento encontrada:", data.fechaNacimiento);
            }

            // Buscar sexo
            const sexMatch = text.match(/\b(?:SEXO|SEX)\s*[:=]?\s*([MF])\b/i);
            if (sexMatch) {
                data.sexo = sexMatch[1].toUpperCase();
                console.log("üìù Sexo encontrado:", data.sexo);
            }

            return data;
        }

        // Funci√≥n para poblar el formulario con datos
        function populateFormWithData(data) {
            console.log("üìù Poblando formulario con datos:", data);

            try {
                // Validar n√∫mero de documento si existe
                if (data.numeroDocumento) {
                    const expectedDoc = window.state.expectedDocument;
                    if (expectedDoc && data.numeroDocumento !== expectedDoc) {
                        showNotification(
                            'El n√∫mero de documento no coincide con el titular de la reserva registrado en nuestro sistema. ' +
                            'Puede continuar completando el formulario, pero tenga en cuenta que no es el titular.',
                            'warning',
                            6000
                        );
                    }
                }

                // Mapear y poblar campos con formato correcto
                if (data.nombre) {
                    document.getElementById('firstName').value = formatToTitleCase(data.nombre);
                    console.log("‚úÖ Nombre poblado:", data.nombre);
                }
                
                if (data.apellido) {
                    document.getElementById('lastName').value = formatToTitleCase(data.apellido);
                    console.log("‚úÖ Apellido poblado:", data.apellido);
                }
        
                if (data.numeroDocumento) {
                    document.getElementById('documentNumber').value = data.numeroDocumento;
                    console.log("‚úÖ N√∫mero de documento poblado:", data.numeroDocumento);
                }
        
                if (data.fechaNacimiento) {
                    document.getElementById('birthDate').value = data.fechaNacimiento;
                    console.log("‚úÖ Fecha de nacimiento poblada:", data.fechaNacimiento);
                }

                if (data.direccion) {
                    document.getElementById('address').value = formatToSentenceCase(data.direccion);
                    console.log("‚úÖ Domicilio poblado:", data.direccion);
                }

                if (data.localidad) {
                    document.getElementById('city').value = formatToSentenceCase(data.localidad);
                    console.log("‚úÖ Localidad poblada:", data.localidad);
                }

                showNotification('Datos extra√≠dos y cargados correctamente', 'success');
            } catch (error) {
                console.error("‚ùå Error al poblar formulario:", error);
                showNotification('Error al cargar los datos en el formulario', 'error');
            }
        }

        // Configuraci√≥n de Drag & Drop
        function setupDragAndDrop(dropAreaId, inputId, fileNameId, previewId, processCallback) {
            // Usar selectores con # para IDs
            const dropArea = document.querySelector(dropAreaId);
            const fileInput = document.querySelector(inputId);
            const fileNameEl = document.querySelector(fileNameId);
            const previewEl = document.querySelector(previewId);
            const uploadBtn = dropArea.querySelector('button[onclick*="click"]');
            
            if (!dropArea || !fileInput || !fileNameEl || !previewEl) {
                console.error('No se encontraron todos los elementos necesarios', {
                    dropArea, fileInput, fileNameEl, previewEl
                });
                return;
            }

            // Remover onclick inline y agregar event listener
            if (uploadBtn) {
                uploadBtn.removeAttribute('onclick');
                uploadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    fileInput.click();
                });
            }
            
            // Prevenir comportamiento predeterminado
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            // Efectos visuales durante el arrastre
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('drag');
                });
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('drag');
                });
            });
            
            // Manejo de archivos soltados
            dropArea.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                if (files.length) {
                    handleFiles(files[0], fileNameEl, previewEl, processCallback);
                }
            });
            
            // Manejo de selecci√≥n de archivo
            fileInput.addEventListener('change', e => {
                if (e.target.files && e.target.files[0]) {
                    handleFiles(e.target.files[0], fileNameEl, previewEl, processCallback);
                }
            });
        }

        // Referencias DOM frecuentes
        function $(selector) {
            const elements = document.querySelectorAll(selector);
            return elements.length === 1 ? elements[0] : Array.from(elements);
        }

        async function initZXing() {
            try {
                console.log("üìö Inicializando ZXing...");
                state.zxingReader = new ZXingBrowser.BrowserPDF417Reader({
                    tryHarder: true
                });
                console.log("‚úÖ ZXing inicializado correctamente");
                return true;
            } catch (error) {
                console.error("‚ùå Error al inicializar ZXing:", error);
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Crear el objeto state en el √°mbito global
            window.state = {
                currentSection: 1,
                totalSections: 3,
                signaturePad: null,
                zxingReader: null,
                tesseractWorker: null,
                expectedDocument: '58163830'
            };

            const state = window.state;

            // Inicializar el lector PDF417
            try {
                await initZXing();
            } catch (error) {
                console.error("‚ùå Error al inicializar lector PDF417:", error);
            }

            // Cache para localidades
            const locationCache = {
                key: 'argentineLocations',
                expirationKey: 'argentineLocationsExpiration',
                expirationTime: 7 * 24 * 60 * 60 * 1000,

                async get() {
                    try {
                        const expiration = localStorage.getItem(this.expirationKey);
                        if (expiration && Date.now() > parseInt(expiration)) {
                            localStorage.removeItem(this.key);
                            localStorage.removeItem(this.expirationKey);
                            return null;
                        }
                        const data = localStorage.getItem(this.key);
                        return data ? JSON.parse(data) : null;
                    } catch (error) {
                        console.error('Error al leer del cache:', error);
                        return null;
                    }
                },

                set(data) {
                    try {
                        localStorage.setItem(this.key, JSON.stringify(data));
                        localStorage.setItem(this.expirationKey, (Date.now() + this.expirationTime).toString());
                    } catch (error) {
                        console.error('Error al guardar en cache:', error);
                    }
                }
            };

            // Utilidad para b√∫squeda fon√©tica (implementaci√≥n simplificada de Metaphone para espa√±ol)
            const PhoneticUtils = {
                normalize(text) {
                    return text.toLowerCase()
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "")
                        .replace(/[√°√†√§√¢]/g, 'a')
                        .replace(/[√©√®√´√™]/g, 'e')
                        .replace(/[√≠√¨√Ø√Æ]/g, 'i')
                        .replace(/[√≥√≤√∂√¥]/g, 'o')
                        .replace(/[√∫√π√º√ª]/g, 'u')
                        .replace(/√±/g, 'n')
                        .replace(/ll/g, 'y')
                        .replace(/ch/g, 'x')
                        .replace(/c([ei])/g, 's$1')
                        .replace(/c/g, 'k')
                        .replace(/z/g, 's')
                        .replace(/v/g, 'b')
                        .replace(/[wy]/g, 'i')
                        .replace(/[^a-z]/g, '');
                },

                arePhoneticallySimilar(str1, str2) {
                    return this.normalize(str1) === this.normalize(str2);
                }
            };

            // Funci√≥n de autocompletado
            async function initLocationAutocomplete() {
                const cityInput = $('#city');
                const provinceInput = $('#province');
                const suggestionsDiv = $('#citySuggestions');
                let localidades = [];
                let provincias = new Set();
                let isLoading = false;
                let selectedIndex = -1;

                // Crear contenedor principal de sugerencias con estilos mejorados
                suggestionsDiv.className = 'absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg border border-gray-200 max-h-96 overflow-hidden';
                
                // Crear contenedor para filtros r√°pidos
                const quickFiltersContainer = document.createElement('div');
                quickFiltersContainer.className = 'p-2 border-b border-gray-200 flex flex-wrap gap-2';
                suggestionsDiv.appendChild(quickFiltersContainer);

                // Crear contenedor para historial
                const historyContainer = document.createElement('div');
                historyContainer.className = 'border-b border-gray-200 history-container';
                suggestionsDiv.appendChild(historyContainer);

                // Crear contenedor para resultados
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'max-h-64 overflow-y-auto';
                suggestionsDiv.appendChild(resultsContainer);

                // Crear indicador de carga con animaci√≥n suave
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'absolute right-3 top-1/2 transform -translate-y-1/2 transition-opacity duration-200 opacity-0';
                loadingIndicator.innerHTML = `
                    <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                `;
                cityInput.parentElement.appendChild(loadingIndicator);

                // Crear bot√≥n de limpiar
                const clearButton = document.createElement('button');
                clearButton.type = 'button';
                clearButton.className = 'absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden transition-opacity duration-200';
                clearButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                `;
                cityInput.parentElement.appendChild(clearButton);

                function showLoadingIndicator() {
                    loadingIndicator.style.opacity = '1';
                    cityInput.classList.add('pr-10');
                }

                function hideLoadingIndicator() {
                    loadingIndicator.style.opacity = '0';
                    cityInput.classList.remove('pr-10');
                }

                // Funci√≥n para actualizar filtros r√°pidos
                function updateQuickFilters() {
                    quickFiltersContainer.innerHTML = '';
                    
                    // Agregar provincias m√°s populares o recientes
                    const popularProvinces = ['Buenos Aires', 'CABA', 'C√≥rdoba', 'Santa Fe', 'Mendoza'];
                    popularProvinces.forEach(provincia => {
                        if (provincias.has(provincia)) {
                            const button = document.createElement('button');
                            button.type = 'button';
                            button.className = `px-3 py-1 rounded-full text-sm ${
                                provinceInput.value === provincia 
                                    ? 'bg-blue-500 text-white' 
                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            } transition-colors`;
                            button.textContent = provincia;
                            button.addEventListener('click', () => {
                                provinceInput.value = provincia;
                                cityInput.value = '';
                                cityInput.focus();
                                showSuggestions('');
                            });
                            quickFiltersContainer.appendChild(button);
                        }
                    });
                }

                // Funci√≥n para mostrar historial
                function showHistory() {
                    historyContainer.innerHTML = '';
                    const history = SearchHistory.get();
                    
                    if (history.length > 0) {
                        const header = document.createElement('div');
                        header.className = 'px-3 py-2 text-sm text-gray-500 flex justify-between items-center bg-gray-50';
                        header.innerHTML = `
                            <span>B√∫squedas recientes</span>
                            <button class="text-xs text-blue-500 hover:text-blue-700" onclick="SearchHistory.clear()">
                                Limpiar historial
                            </button>
                        `;
                        historyContainer.appendChild(header);

                        history.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'px-3 py-2 hover:bg-gray-50 cursor-pointer flex items-center';
                            div.innerHTML = `
                                <svg class="h-4 w-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div>
                                    <div class="font-medium">${item.ciudad}</div>
                                    <div class="text-sm text-gray-500">${item.provincia}</div>
                                </div>
                            `;
                            div.addEventListener('click', () => {
                                cityInput.value = item.ciudad;
                                provinceInput.value = item.provincia;
                                SearchHistory.add(item);
                                suggestionsDiv.classList.add('hidden');
                            });
                            historyContainer.appendChild(div);
                        });
                    }
                }

                // Funci√≥n mejorada para mostrar sugerencias
                function showSuggestions(input) {
                    const text = input.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    resultsContainer.innerHTML = '';
                    
                    if (!text) {
                        updateQuickFilters();
                        showHistory();
                        suggestionsDiv.classList.remove('hidden');
                        return;
                    }

                    if (text.length < 2) {
                        suggestionsDiv.classList.add('hidden');
                        return;
                    }

                    // Filtrar localidades
                    let matches = localidades
                        .filter(loc => {
                            const matchesProvince = !provinceInput.value || loc.provincia === provinceInput.value;
                            const matchesText = loc.normalized.includes(text);
                            const phoneticMatch = !matchesText && PhoneticUtils.arePhoneticallySimilar(loc.ciudad, input);
                            return matchesProvince && (matchesText || phoneticMatch);
                        })
                        .slice(0, 10);

                    // Ordenar resultados: exactos primero, luego fon√©ticos
                    matches.sort((a, b) => {
                        const aExact = a.normalized.includes(text);
                        const bExact = b.normalized.includes(text);
                        if (aExact && !bExact) return -1;
                        if (!aExact && bExact) return 1;
                        return a.ciudad.localeCompare(b.ciudad);
                    });

                    if (matches.length > 0) {
                        matches.forEach((match, index) => {
                            const div = document.createElement('div');
                            div.className = `p-3 hover:bg-blue-50 cursor-pointer ${
                                index === selectedIndex ? 'bg-blue-50' : ''
                            }`;
                            
                            const cityHTML = match.ciudad.replace(
                                new RegExp(text, 'gi'),
                                match => `<strong class="text-blue-600">${match}</strong>`
                            );
                            
                            div.innerHTML = `
                                <div class="font-medium">${cityHTML}</div>
                                <div class="text-sm text-gray-500">${match.provincia}</div>
                            `;
                            
                            div.addEventListener('click', () => {
                                cityInput.value = match.ciudad;
                                provinceInput.value = match.provincia;
                                SearchHistory.add(match);
                                suggestionsDiv.classList.add('hidden');
                            });
                            
                            resultsContainer.appendChild(div);
                        });
                    } else {
                        const noResults = document.createElement('div');
                        noResults.className = 'p-4 text-center text-gray-500';
                        noResults.innerHTML = `
                            <svg class="mx-auto h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div>No se encontraron resultados</div>
                            <div class="text-sm mt-1">Intenta con otra b√∫squeda</div>
                        `;
                        resultsContainer.appendChild(noResults);
                    }

                    suggestionsDiv.classList.remove('hidden');
                }

                // Funci√≥n para limpiar la b√∫squeda
                function clearSearch() {
                    cityInput.value = '';
                    provinceInput.value = '';
                    clearButton.classList.add('hidden');
                    cityInput.focus();
                    showSuggestions('');
                }

                // Event listeners mejorados
                let debounceTimer;
                cityInput.addEventListener('input', (e) => {
                    clearTimeout(debounceTimer);
                    const value = e.target.value;
                    clearButton.classList.toggle('hidden', !value);
                    debounceTimer = setTimeout(() => showSuggestions(value), 150);
                });

                cityInput.addEventListener('focus', () => {
                    showSuggestions(cityInput.value);
                });

                clearButton.addEventListener('click', clearSearch);

                // Navegaci√≥n por teclado mejorada
                cityInput.addEventListener('keydown', (e) => {
                    const suggestions = resultsContainer.children;
                    
                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                            updateSelection();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            selectedIndex = Math.max(selectedIndex - 1, -1);
                            updateSelection();
                            break;
                        case 'Enter':
                            e.preventDefault();
                            if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                                suggestions[selectedIndex].click();
                            }
                            break;
                        case 'Escape':
                            suggestionsDiv.classList.add('hidden');
                            selectedIndex = -1;
                            break;
                        case 'Backspace':
                            if (!cityInput.value && provinceInput.value) {
                                provinceInput.value = '';
                                showSuggestions('');
                            }
                            break;
                    }
                });

                function updateSelection() {
                    Array.from(resultsContainer.children).forEach((el, index) => {
                        el.classList.toggle('bg-blue-50', index === selectedIndex);
                        if (index === selectedIndex) {
                            el.scrollIntoView({ block: 'nearest' });
                        }
                    });
                }

                // Cargar datos iniciales
                async function loadLocations() {
                    try {
                        const cachedData = await locationCache.get();
                        if (cachedData) {
                            console.log('‚úÖ Usando datos en cach√©');
                            localidades = cachedData.localidades;
                            provincias = new Set(cachedData.provincias);
                            updateQuickFilters();
                            return true;
                        }

                        showLoadingIndicator();
                        isLoading = true;

                        const response = await fetch('https://apis.datos.gob.ar/georef/api/localidades?max=4000&campos=nombre,provincia.nombre&orden=nombre');
                        if (!response.ok) throw new Error('Error en la respuesta de la API');
                        
                        const data = await response.json();
                        localidades = data.localidades.map(loc => ({
                            ciudad: loc.nombre,
                            provincia: loc.provincia.nombre,
                            normalized: loc.nombre.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        }));

                        localidades.sort((a, b) => a.ciudad.localeCompare(b.ciudad));
                        provincias = new Set(localidades.map(loc => loc.provincia));

                        locationCache.set({
                            localidades,
                            provincias: Array.from(provincias)
                        });

                        updateQuickFilters();
                        console.log('‚úÖ Localidades cargadas:', localidades.length);
                        return true;
                    } catch (error) {
                        console.error('Error al cargar localidades:', error);
                        showNotification('Error al cargar las localidades. Por favor, intente m√°s tarde.', 'error');
                        return false;
                    } finally {
                        isLoading = false;
                        hideLoadingIndicator();
                    }
                }

                // Cerrar sugerencias al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!cityInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                        suggestionsDiv.classList.add('hidden');
                        selectedIndex = -1;
                    }
                });

                // Inicializaci√≥n
                await loadLocations();
                showHistory();
            }

            // Declaraci√≥n de funciones necesarias antes de llamarlas
            function initSignaturePad() {
                const canvas = $('#signatureCanvas');
                if (!canvas) {
                    console.error('Canvas de firma no encontrado');
                    return null;
                }

                // Ajustar el tama√±o del canvas al contenedor
                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    const container = canvas.parentElement;
                    canvas.width = container.offsetWidth * ratio;
                    canvas.height = 200 * ratio; // Altura fija de 200px
                    canvas.getContext('2d').scale(ratio, ratio);
                }

                // Inicializar SignaturePad
                resizeCanvas();
                const signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 0.5,
                    maxWidth: 2.5,
                    throttle: 16, // M√°ximo de eventos por segundo
                    velocityFilterWeight: 0.7
                });

                // Manejar redimensionamiento de ventana
                window.addEventListener('resize', () => {
                    // Guardar la firma actual
                    const data = signaturePad.toData();
                    resizeCanvas();
                    signaturePad.fromData(data || []);
                });

                return signaturePad;
            }

            function showSection(sectionNumber) {
                $('.section').forEach(section => {
                    section.classList.remove('active');
                });
                $(`#section${sectionNumber}`).classList.add('active');
            }

            function updateProgressBar(currentStep) {
                $('.progress-step').forEach((step, index) => {
                    step.classList.remove('active', 'completed');
                    if (index + 1 === currentStep) {
                        step.classList.add('active');
                    } else if (index + 1 < currentStep) {
                        step.classList.add('completed');
                    }
                });

                const progress = ((currentStep - 1) / (state.totalSections - 1)) * 100;
                $('#progressBar').style.width = `${progress}%`;
            }

            function validateSection(sectionNumber) {
                const section = $(`#section${sectionNumber}`);
                if (!section) return false;

                let isValid = true;
                const errorMessages = [];

                // Validar campos requeridos
                section.querySelectorAll('input[required], select[required]').forEach(field => {
                    const fieldName = field.getAttribute('placeholder') || field.getAttribute('name') || field.id || 'Campo';
                    
                    // Validaci√≥n especial para WhatsApp
                    if (field.id === 'whatsapp') {
                        if (!validateWhatsApp(field)) {
                            isValid = false;
                            errorMessages.push('Ingrese un n√∫mero de WhatsApp v√°lido');
                            return;
                        }
                    }
                    
                    if (!field.value) {
                        isValid = false;
                        field.classList.add('border-red-500');
                        
                        const errorElement = document.querySelector(`[data-error-for="${field.name || field.id}"]`);
                        if (errorElement) {
                            errorElement.classList.remove('hidden');
                        }
                        
                        errorMessages.push(`${fieldName} es requerido`);
                    } else {
                        if (field.id !== 'whatsapp') { // No modificar clases para WhatsApp aqu√≠
                            field.classList.remove('border-red-500');
                            
                            const errorElement = document.querySelector(`[data-error-for="${field.name || field.id}"]`);
                            if (errorElement) {
                                errorElement.classList.add('hidden');
                            }
                        }
                    }
                });

                // Validar firma en la primera secci√≥n
                if (sectionNumber === 1) {
                    const signatureError = $('#signatureError');
                    if (state.signaturePad && state.signaturePad.isEmpty()) {
                        isValid = false;
                        if (signatureError) {
                            signatureError.classList.remove('hidden');
                        }
                        errorMessages.push('La firma es requerida');
                    } else if (signatureError) {
                        signatureError.classList.add('hidden');
                    }
                }

                if (!isValid && errorMessages.length > 0) {
                    showNotification(errorMessages[0], 'error');
                }

                return isValid;
            }

            function handleNavigation(direction) {
                const currentSection = state.currentSection;
                let nextSection = direction === 'next' ? currentSection + 1 : currentSection - 1;

                if (nextSection < 1 || nextSection > state.totalSections) return;

                if (direction === 'next' && !validateSection(currentSection)) {
                    return;
                }

                showSection(nextSection);
                updateProgressBar(nextSection);
                state.currentSection = nextSection;
                
                // Si vamos a la secci√≥n de resumen, actualizarlo
                if (nextSection === 3) {
                    updateResumen();
                }
            }

            function updateResumen() {
                // Datos del Titular
                $('#resumen-nombre').textContent = $('#firstName').value || '-';
                $('#resumen-apellido').textContent = $('#lastName').value || '-';
                $('#resumen-documento').textContent = 
                    `${$('#documentType').value} ${$('#documentNumber').value}` || '-';
                $('#resumen-nacimiento').textContent = $('#birthDate').value || '-';
                $('#resumen-whatsapp').textContent = $('#whatsapp').value || '-';
                $('#resumen-email').textContent = $('#email').value || '-';
                $('#resumen-direccion').textContent = $('#address').value || '-';
                $('#resumen-localidad').textContent = $('#city').value || '-';
                $('#resumen-provincia').textContent = $('#province').value || '-';
                $('#resumen-marca').textContent = $('#carBrand').value || '-';
                $('#resumen-patente').textContent = $('#licensePlate').value || '-';

                // Acompa√±ante adulto
                const hasAdult = $('input[name="adultCompanion"]:checked')?.value === 'si';
                $('#summaryAdultCompanion').classList.toggle('hidden', !hasAdult);
                
                if (hasAdult) {
                    $('#summaryAdultName').textContent = 
                        `${$('#adultFirstName').value || ''} ${$('#adultLastName').value || ''}`.trim() || '-';
                    $('#summaryAdultDocument').textContent = $('#adultDNI').value || '-';
                    $('#summaryAdultWhatsapp').textContent = $('#adultWhatsapp').value || '-';
                    $('#summaryAdultEmail').textContent = $('#adultEmail').value || '-';
                }

                // Menores
                const hasMinors = $('input[name="minorCompanions"]:checked')?.value === 'si';
                $('#summaryMinorCompanions').classList.toggle('hidden', !hasMinors);
                
                if (hasMinors) {
                    const minorsContainer = $('#minorsResumen');
                    minorsContainer.innerHTML = '';
                    
                    $('#minorFields > div').forEach((minorGroup, index) => {
                        const firstName = minorGroup.querySelector('.minor-first')?.value || '';
                        const lastName = minorGroup.querySelector('.minor-last')?.value || '';
                        const birthDate = minorGroup.querySelector('.minor-birth')?.value || '';
                        const dni = minorGroup.querySelector('.minor-dni')?.value || '';
                        
                        // Solo agregar al resumen si hay al menos un campo relleno
                        if (firstName || lastName || birthDate || dni) {
                            const minorDiv = document.createElement('div');
                            minorDiv.className = 'py-2';
                            minorDiv.innerHTML = `
                                <div class="font-medium">Menor ${index + 1}</div>
                                <div class="grid sm:grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span class="text-gray-600">Nombre:</span>
                                        <span>${firstName} ${lastName}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">DNI:</span>
                                        <span>${dni || '-'}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Nacimiento:</span>
                                        <span>${birthDate || '-'}</span>
                                    </div>
                                </div>
                            `;
                            minorsContainer.appendChild(minorDiv);
                        }
                    });
                }
            }

            async function handleFormSubmit(event) {
                event.preventDefault();
                
                const form = event.target;
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('loadingText').textContent = 'Enviando datos...';

                try {
                    // Recolectar datos del formulario manualmente
                    const titularData = {
                        documentType: $('#documentType').value,
                        firstName: $('#firstName').value,
                        lastName: $('#lastName').value,
                        documentNumber: $('#documentNumber').value,
                        birthDate: $('#birthDate').value,
                        address: $('#address').value,
                        city: $('#city').value,
                        province: $('#province').value,
                        email: $('#email').value,
                        whatsapp: $('#whatsapp').value,
                        carBrand: $('#carBrand').value || '',
                        licensePlate: $('#licensePlate').value || '',
                        timestamp: new Date().toISOString()
                    };

                    // Procesar acompa√±ante adulto si existe
                    const adultCompanionRadio = $('input[name="adultCompanion"]:checked');
                    if (adultCompanionRadio && adultCompanionRadio.value === 'si') {
                        titularData.adultCompanion = {
                            firstName: $('#adultFirstName').value || '',
                            lastName: $('#adultLastName').value || '',
                            documentNumber: $('#adultDNI').value || '',
                            whatsapp: $('#adultWhatsapp').value || '',
                            email: $('#adultEmail').value || ''
                        };
                    }

                    // Procesar menores si existen
                    const minorCompanionsRadio = $('input[name="minorCompanions"]:checked');
                    if (minorCompanionsRadio && minorCompanionsRadio.value === 'si') {
                        const minorsData = [];
                        $('#minorFields > div').forEach(minorGroup => {
                            const firstName = minorGroup.querySelector('.minor-first')?.value || '';
                            const lastName = minorGroup.querySelector('.minor-last')?.value || '';
                            const birthDate = minorGroup.querySelector('.minor-birth')?.value || '';
                            const dni = minorGroup.querySelector('.minor-dni')?.value || '';
                            
                            if (firstName || lastName || birthDate || dni) {
                                minorsData.push({
                                    firstName: firstName,
                                    lastName: lastName,
                                    birthDate: birthDate,
                                    documentNumber: dni
                                });
                            }
                        });
                        if (minorsData.length > 0) {
                            titularData.minorCompanions = minorsData;
                        }
                    }

                    console.log("Enviando datos:", titularData);

                    // Crear FormData para el env√≠o
                    const submitData = new FormData();
                    
                    // Agregar los datos del formulario como JSON
                    submitData.append('data', JSON.stringify(titularData));
                    
                    // Agregar archivos si existen
                    const documentFront = $('#documentFront').files[0];
                    if (documentFront) {
                        submitData.append('documentFront', documentFront, documentFront.name);
                        console.log("Documento frontal agregado:", documentFront.name);
                    }
                    
                    const documentBack = $('#documentBack').files[0];
                    if (documentBack) {
                        submitData.append('documentBack', documentBack, documentBack.name);
                        console.log("Documento posterior agregado:", documentBack.name);
                    }
                    
                    // Agregar firma si existe
                    if (state.signaturePad && !state.signaturePad.isEmpty()) {
                        try {
                            console.log("Preparando firma para env√≠o...");
                            // Obtener la firma como PNG base64
                            const signatureData = state.signaturePad.toDataURL('image/png');
                            
                            // M√©todo mejorado para convertir base64 a blob
                            const fetchResponse = await fetch(signatureData);
                            const signatureBlob = await fetchResponse.blob();
                            
                            // Crear el archivo con un nombre √∫nico incluyendo timestamp
                            const timestamp = new Date().getTime();
                            const signatureFile = new File(
                                [signatureBlob], 
                                `signature_${timestamp}.png`, 
                                { type: 'image/png' }
                            );
                            
                            // Registrar tama√±o para verificar
                            console.log(`Firma lista para env√≠o: ${signatureFile.size} bytes`);
                            
                            // Agregar al FormData con un nombre de campo expl√≠cito 
                            submitData.append('signature', signatureFile, signatureFile.name);
                            
                            // Tambi√©n enviar como base64 para redundancia
                            submitData.append('signatureBase64', signatureData);
                            
                            console.log("Firma preparada y agregada al formulario");
                        } catch (error) {
                            console.error("Error al procesar la firma:", error);
                        }
                    }

                    // Enviar datos a Cloudflare
                    const response = await fetch('https://round-term-80a4.fvazquez-2f3.workers.dev', {
                        method: 'POST',
                        body: submitData
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('Respuesta de error del servidor:', errorData);
                        throw new Error(`Error en el servidor: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log("‚úÖ Datos enviados correctamente:", result);
                    
                    // Mostrar mensaje de √©xito
                    document.getElementById('successMessage').classList.remove('hidden');
                    showNotification('Check-in completado exitosamente', 'success');
                    
                    // Desactivar el formulario
                    form.classList.add('opacity-50', 'pointer-events-none');
                } catch (error) {
                    console.error('‚ùå Error al enviar formulario:', error);
                    showNotification('Error al procesar el check-in: ' + error.message, 'error');
                } finally {
                    document.getElementById('loadingIndicator').classList.add('hidden');
                }
            }

            function initEventListeners() {
                // Configurar Drag & Drop
                setupDragAndDrop('#dropFront', '#documentFront', '#frontFileName', '#frontPreview', processDocumentFront);
                setupDragAndDrop('#dropBack', '#documentBack', '#backFileName', '#backPreview', processDocumentBack);
                
                // Navegaci√≥n entre secciones
                $('#btnNext1').addEventListener('click', () => handleNavigation('next'));
                $('#btnPrev2').addEventListener('click', () => handleNavigation('prev'));
                $('#btnNext2').addEventListener('click', () => handleNavigation('next'));
                $('#btnPrev3').addEventListener('click', () => handleNavigation('prev'));
                
                // Limpiar firma
                $('#clearSignature').addEventListener('click', () => {
                    state.signaturePad.clear();
                    $('#signatureError').classList.add('hidden');
                });
                
                // Toggle de campos de acompa√±antes
                document.querySelectorAll('input[name="adultCompanion"]').forEach(radio => {
                    radio.addEventListener('change', e => {
                        document.querySelector('#adultFields').classList.toggle('hidden', e.target.value !== 'si');
                    });
                });
                
                $('input[name="minorCompanions"]').forEach(radio => {
                    radio.addEventListener('change', e => {
                        const minorFields = $('#minorFields');
                        const showMinors = e.target.value === 'si';
                        
                        minorFields.classList.toggle('hidden', !showMinors);
                        
                        if (showMinors) {
                            // Generar campos para tres menores
                            minorFields.innerHTML = '';
                            for (let i = 1; i <= 3; i++) {
                                const template = document.getElementById('minorTemplate').content.cloneNode(true);
                                template.querySelector('.minorIndex').textContent = i;
                                minorFields.appendChild(template);
                            }
                        }
                    });
                });
                
                // Env√≠o del formulario
                $('#checkInForm').addEventListener('submit', handleFormSubmit);
                
                // Actualizar resumen cuando se cambian datos
                const formInputs = $('#checkInForm input, #checkInForm select');
                formInputs.forEach(input => {
                    input.addEventListener('change', updateResumen);
                    input.addEventListener('input', updateResumen);
                });
            }

            // Limpieza al cerrar la ventana
            window.addEventListener('beforeunload', async () => {
                if (state.tesseractWorker) {
                    try {
                        await state.tesseractWorker.terminate();
                    } catch (e) {
                        console.error('Error al terminar el worker Tesseract:', e);
                    }
                }
            });

            // Inicializaci√≥n de la aplicaci√≥n
            initEventListeners();
            state.signaturePad = initSignaturePad();
            await initLocationAutocomplete(); // Ahora esperamos a que se inicialice
            updateProgressBar(1);

            // Manejar cambios en el tipo de documento
            const documentTypeSelect = document.getElementById('documentType');
            const cityInput = document.getElementById('city');
            const provinceInput = document.getElementById('province');
            const countryField = document.getElementById('countryField');
            const countryInput = document.getElementById('country');
            const citySuggestions = document.getElementById('citySuggestions');
            
            function updateDocumentFields() {
                const isForeign = documentTypeSelect.value === 'passport' || documentTypeSelect.value === 'foreign_id';
                console.log('Tipo de documento:', documentTypeSelect.value, 'Es extranjero:', isForeign);
                
                // Mostrar/ocultar campo de pa√≠s
                countryField.classList.toggle('hidden', !isForeign);
                countryInput.required = isForeign;
                
                // Configurar campos de localidad y provincia
                if (isForeign) {
                    // Desactivar autocompletado para documentos extranjeros
                    cityInput.removeAttribute('autocomplete');
                    cityInput.classList.remove('pr-10');
                    provinceInput.removeAttribute('readonly');
                    provinceInput.classList.remove('bg-gray-50');
                    
                    // Ocultar sugerencias de localidad
                    if (citySuggestions) {
                        citySuggestions.classList.add('hidden');
                    }
                    
                    // Limpiar valores
                    cityInput.value = '';
                    provinceInput.value = '';
                    countryInput.value = '';
                    
                    // Actualizar placeholders
                    cityInput.placeholder = 'Ingrese la localidad';
                    provinceInput.placeholder = 'Ingrese la provincia';
                } else {
                    // Reactivar autocompletado para DNI argentino
                    cityInput.setAttribute('autocomplete', 'off');
                    cityInput.classList.add('pr-10');
                    provinceInput.setAttribute('readonly', 'readonly');
                    provinceInput.classList.add('bg-gray-50');
                    
                    // Limpiar valores
                    cityInput.value = '';
                    provinceInput.value = '';
                    countryInput.value = '';
                    
                    // Restaurar placeholders
                    cityInput.placeholder = '';
                    provinceInput.placeholder = '';
                }
            }
            
            // Ejecutar al cargar la p√°gina
            updateDocumentFields();
            
            // Ejecutar cuando cambie el tipo de documento
            documentTypeSelect.addEventListener('change', updateDocumentFields);
        });

        // Agregar esta funci√≥n despu√©s de las otras funciones pero dentro del script
        function validateWhatsApp(input) {
            const prefixInput = document.getElementById('whatsappPrefix');
            const numberInput = document.getElementById('whatsappNumber');
            const hiddenInput = document.getElementById('whatsapp');
            const errorElement = document.querySelector('[data-error-for="whatsapp"]');
            const checkIcon = input.parentElement.querySelector('.whatsapp-check');
            const errorIcon = input.parentElement.querySelector('.whatsapp-error');
            
            // Si el campo est√° vac√≠o, no mostrar error
            if (!numberInput.value.trim()) {
                errorElement?.classList.add('hidden');
                errorIcon?.classList.add('hidden');
                checkIcon?.classList.add('hidden');
                numberInput.classList.remove('border-red-500', 'border-green-500');
                prefixInput.classList.remove('border-red-500', 'border-green-500');
                return true;
            }
            
            // Limpiar caracteres no permitidos
            let prefix = prefixInput.value.trim().replace(/[^0-9+]/g, '');
            let number = numberInput.value.trim().replace(/[^0-9]/g, '');
            
            // Asegurar que el prefijo comience con +
            if (!prefix.startsWith('+')) {
                prefix = '+' + prefix;
            }
            
            // Actualizar valores limpios
            prefixInput.value = prefix;
            numberInput.value = number;
            
            // Combinar prefijo y n√∫mero para el campo oculto
            hiddenInput.value = prefix + number;

            // Validar el formato completo
            const isValidPrefix = /^\+\d{1,4}$/.test(prefix);
            const isValidNumber = number.length >= 8 && number.length <= 15;
            const isValid = isValidPrefix && isValidNumber;
            
            // Actualizar UI solo si hay alg√∫n valor ingresado
            if (number.length > 0) {
                numberInput.classList.toggle('border-red-500', !isValid);
                numberInput.classList.toggle('border-green-500', isValid);
                prefixInput.classList.toggle('border-red-500', !isValidPrefix);
                prefixInput.classList.toggle('border-green-500', isValidPrefix);
                
                if (!isValid) {
                    let errorMsg = '';
                    if (!isValidPrefix) {
                        errorMsg = 'Prefijo inv√°lido (debe comenzar con + y tener 1-4 d√≠gitos)';
                    } else if (!isValidNumber) {
                        errorMsg = 'N√∫mero inv√°lido (debe tener entre 8 y 15 d√≠gitos)';
                    }
                    if (errorElement) {
                        errorElement.textContent = errorMsg;
                        errorElement.classList.remove('hidden');
                    }
                } else {
                    errorElement?.classList.add('hidden');
                }
            }
            
            if (checkIcon) {
                checkIcon.classList.toggle('hidden', !isValid);
            }
            
            if (errorIcon) {
                errorIcon.classList.toggle('hidden', isValid || number.length === 0);
            }

            // Si el n√∫mero es v√°lido, validar con la API
            if (isValid) {
                validateWhatsAppAPI(hiddenInput.value).then(isWhatsApp => {
                    if (!isWhatsApp) {
                        numberInput.classList.remove('border-green-500');
                        numberInput.classList.add('border-red-500');
                        if (errorElement) {
                            errorElement.textContent = 'Este n√∫mero no parece estar registrado en WhatsApp';
                            errorElement.classList.remove('hidden');
                        }
                        if (checkIcon) checkIcon.classList.add('hidden');
                        if (errorIcon) errorIcon.classList.remove('hidden');
                    }
                }).catch(console.error);
            }
            
            return isValid || number.length === 0;
        }

        // Agregar event listeners para WhatsApp despu√©s del DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            const prefixInput = document.getElementById('whatsappPrefix');
            const numberInput = document.getElementById('whatsappNumber');
            
            // No validar inmediatamente al cargar la p√°gina
            prefixInput.addEventListener('input', () => validateWhatsApp(numberInput));
            numberInput.addEventListener('input', () => validateWhatsApp(numberInput));
        });

        // Funci√≥n para validaci√≥n avanzada de WhatsApp (opcional)
        async function validateWhatsAppAPI(phoneNumber) {
            try {
                // TODO: Implementar llamada a API externa cuando se decida cu√°l usar
                // Por ahora retornamos true para no bloquear el flujo
                return true;
            } catch (error) {
                console.error('Error validando WhatsApp:', error);
                return true; // En caso de error, permitimos continuar
            }
        }

        // Funci√≥n para abrir la c√°mara
        async function openCamera(inputId) {
            const previewArea = document.querySelector(`#${inputId === 'documentFront' ? 'frontPreview' : 'backPreview'}`);
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'flex justify-center gap-4 mt-4';
            
            // Crear elementos de UI
            const videoPreview = document.createElement('video');
            videoPreview.className = 'w-full h-auto';
            videoPreview.autoplay = true;
            videoPreview.playsInline = true;
            
            // Botones de control
            const captureBtn = document.createElement('button');
            captureBtn.className = 'capture-btn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center';
            captureBtn.innerHTML = `
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Capturar
            `;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-btn bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center';
            cancelBtn.innerHTML = `
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Cancelar
            `;
            
            buttonsContainer.appendChild(captureBtn);
            buttonsContainer.appendChild(cancelBtn);
            
            try {
                // Limpiar √°rea de vista previa
                previewArea.innerHTML = '';
                previewArea.appendChild(videoPreview);
                previewArea.appendChild(buttonsContainer);
                
                // Configurar restricciones de video con mejor calidad
                const constraints = {
                    video: {
                        facingMode: { exact: "environment" },
                        width: { ideal: 3840 }, // 4K
                        height: { ideal: 2160 },
                        focusMode: { ideal: "continuous" },
                        whiteBalanceMode: { ideal: "continuous" },
                        exposureMode: { ideal: "continuous" }
                    }
                };
                
                // Solicitar acceso a la c√°mara con manejo de errores mejorado
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (initialError) {
                    console.warn('Error con c√°mara trasera de alta calidad, intentando con configuraci√≥n alternativa:', initialError);
                    
                    // Intentar con configuraci√≥n HD
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: "environment",
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                }
                
                videoPreview.srcObject = stream;
                
                // Funci√≥n para capturar imagen con calidad mejorada
                async function captureImage() {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = videoPreview.videoWidth;
                        canvas.height = videoPreview.videoHeight;
                        const ctx = canvas.getContext('2d');
                        
                        // Dibujar imagen original
                        ctx.drawImage(videoPreview, 0, 0);
                        
                        // Convertir a archivo con m√°xima calidad
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 1.0));
                        const file = new File([blob], `${inputId}_capture.jpg`, { type: 'image/jpeg' });
                        
                        // Actualizar input y vista previa
                        const input = document.getElementById(inputId);
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        input.files = dataTransfer.files;
                        
                        // Mostrar vista previa en color original
                        const img = new Image();
                        img.src = canvas.toDataURL('image/jpeg', 1.0);
                        img.className = 'max-h-48 mx-auto';
                        previewArea.innerHTML = '';
                        previewArea.appendChild(img);
                        
                        // Procesar imagen seg√∫n tipo
                        if (inputId === 'documentFront') {
                            await processDocumentFront(file);
                        } else {
                            await processDocumentBack(file);
                        }
                        
                        // Detener la c√°mara
                        stream.getTracks().forEach(track => track.stop());
                        
                    } catch (error) {
                        console.error('Error al capturar imagen:', error);
                        showNotification('Error al capturar la imagen. Por favor, intente nuevamente.', 'error');
                    }
                }
                
                // Configurar eventos
                captureBtn.onclick = captureImage;
                cancelBtn.onclick = () => {
                    stream.getTracks().forEach(track => track.stop());
                    previewArea.innerHTML = `<span class="text-gray-500">Vista previa ${inputId === 'documentFront' ? 'del frente' : 'del dorso'}</span>`;
                };
                
            } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
                showNotification('No se pudo acceder a la c√°mara. Por favor, verifique los permisos.', 'error');
                previewArea.innerHTML = `<span class="text-red-500">Error al acceder a la c√°mara: ${error.message}</span>`;
            }
        }

        // Funci√≥n mejorada para manejar archivos
        function handleFiles(file, fileNameEl, previewEl, processCallback) {
            console.log('Manejando archivo:', file?.name);
            
            if (!file) {
                console.warn('No se recibi√≥ ning√∫n archivo');
                return;
            }
            
            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                console.warn('Tipo de archivo inv√°lido:', file.type);
                showNotification('Por favor, seleccione un archivo de imagen v√°lido', 'error');
                return;
            }

            console.log('Archivo v√°lido, actualizando UI');

            // Actualizar nombre del archivo
            fileNameEl.textContent = file.name;
            
            // Actualizar el input file correspondiente
            const inputId = fileNameEl.id.includes('front') ? 'documentFront' : 'documentBack';
            const input = document.getElementById(inputId);
            if (input) {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                console.log('Input file actualizado:', inputId);
            }
            
            // Mostrar vista previa
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('Archivo cargado, mostrando vista previa');
                previewEl.innerHTML = '';
                const img = new Image();
                img.src = e.target.result;
                img.className = 'max-h-48 mx-auto';
                img.onload = function() {
                    previewEl.appendChild(img);
                    
                    // Procesar el archivo si hay callback
                    if (processCallback) {
                        console.log('Iniciando procesamiento del archivo');
                        processCallback(file);
                    }
                };
            };
            
            reader.onerror = function(error) {
                console.error('Error al leer el archivo:', error);
                showNotification('Error al leer el archivo', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando manejadores de archivos...');

            // Funci√≥n auxiliar para crear un nuevo input file
            function triggerFileInput(targetId) {
                console.log('Creando nuevo input file para:', targetId);
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.accept = 'image/*';
                tempInput.style.display = 'none';
                document.body.appendChild(tempInput);

                tempInput.onchange = function(e) {
                    console.log('Archivo seleccionado en input temporal');
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        const preview = document.getElementById(`${targetId === 'documentFront' ? 'front' : 'back'}Preview`);
                        const fileName = document.getElementById(`${targetId === 'documentFront' ? 'front' : 'back'}FileName`);
                        
                        console.log('Procesando archivo:', file.name);
                        
                        // Actualizar nombre del archivo
                        fileName.textContent = file.name;
                        
                        // Actualizar el input file correspondiente
                        const input = document.getElementById(targetId);
                        if (input) {
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            input.files = dataTransfer.files;
                            console.log('Input file actualizado:', targetId);
                        }
                        
                        // Mostrar vista previa
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            console.log('Archivo cargado, mostrando vista previa');
                            preview.innerHTML = '';
                            const img = new Image();
                            img.src = e.target.result;
                            img.className = 'max-h-48 mx-auto';
                            img.onload = function() {
                                preview.appendChild(img);
                                
                                // Procesar el archivo seg√∫n el tipo
                                if (targetId === 'documentFront') {
                                    processDocumentFront(file);
                                } else {
                                    processDocumentBack(file);
                                }
                            };
                        };
                        
                        reader.onerror = function(error) {
                            console.error('Error al leer el archivo:', error);
                            showNotification('Error al leer el archivo', 'error');
                        };
                        
                        reader.readAsDataURL(file);
                    }
                    
                    // Limpiar el input temporal
                    document.body.removeChild(tempInput);
                };

                tempInput.click();
            }

            // Inicializar botones de subida de archivo
            const uploadButtons = document.querySelectorAll('.upload-file-btn');
            console.log('Botones de subida encontrados:', uploadButtons.length);
            
            uploadButtons.forEach(button => {
                button.onclick = async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const targetId = this.getAttribute('data-target');
                    console.log('Click en bot√≥n de subida, target:', targetId);
                    
                    const tempInput = document.createElement('input');
                    tempInput.type = 'file';
                    tempInput.accept = 'image/*';
                    tempInput.style.display = 'none';
                    document.body.appendChild(tempInput);

                    tempInput.onchange = async function(e) {
                        if (this.files && this.files[0]) {
                            const file = this.files[0];
                            const preview = document.getElementById(`${targetId === 'documentFront' ? 'front' : 'back'}Preview`);
                            const fileName = document.getElementById(`${targetId === 'documentFront' ? 'front' : 'back'}FileName`);
                            
                            // Actualizar nombre del archivo
                            fileName.textContent = file.name;
                            
                            // Actualizar el input file correspondiente
                            const input = document.getElementById(targetId);
                            if (input) {
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                input.files = dataTransfer.files;
                            }
                            
                            // Mostrar vista previa
                            const reader = new FileReader();
                            reader.onload = async function(e) {
                                preview.innerHTML = '';
                                const img = new Image();
                                img.src = e.target.result;
                                img.className = 'max-h-48 mx-auto';
                                preview.appendChild(img);
                                
                                try {
                                    if (targetId === 'documentFront') {
                                        await processDocumentFront(file);
                                    } else {
                                        await processDocumentBack(file);
                                    }
                                } catch (error) {
                                    console.error('Error al procesar el archivo:', error);
                                    showNotification('Error al procesar el archivo', 'error');
                                }
                            };
                            
                            reader.onerror = function(error) {
                                console.error('Error al leer el archivo:', error);
                                showNotification('Error al leer el archivo', 'error');
                            };
                            
                            reader.readAsDataURL(file);
                        }
                        document.body.removeChild(tempInput);
                    };

                    tempInput.click();
                };
            });

            // Configurar botones de c√°mara
            const cameraButtons = document.querySelectorAll('.camera-btn');
            console.log('Botones de c√°mara encontrados:', cameraButtons.length);
            
            cameraButtons.forEach(button => {
                button.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const targetId = this.getAttribute('data-target');
                    console.log('Click en bot√≥n de c√°mara, target:', targetId);
                    if (targetId) {
                        openCamera(targetId);
                    }
                };
            });

            // Configurar drag & drop
            ['dropFront', 'dropBack'].forEach(dropAreaId => {
                const dropArea = document.getElementById(dropAreaId);
                const inputId = dropAreaId === 'dropFront' ? 'documentFront' : 'documentBack';
                const input = document.getElementById(inputId);
                const preview = document.getElementById(`${inputId === 'documentFront' ? 'front' : 'back'}Preview`);
                const fileName = document.getElementById(`${inputId === 'documentFront' ? 'front' : 'back'}FileName`);
                
                if (dropArea && input && preview && fileName) {
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropArea.addEventListener(eventName, function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    });

                    ['dragenter', 'dragover'].forEach(eventName => {
                        dropArea.addEventListener(eventName, function() {
                            this.classList.add('drag');
                        });
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        dropArea.addEventListener(eventName, function() {
                            this.classList.remove('drag');
                        });
                    });

                    dropArea.addEventListener('drop', function(e) {
                        const files = e.dataTransfer.files;
                        if (files.length) {
                            handleFiles(
                                files[0],
                                fileName,
                                preview,
                                inputId === 'documentFront' ? processDocumentFront : processDocumentBack
                            );
                        }
                    });
                }
            });
        });

        function parsePDF417Data(rawData) {
            console.log("üîç Analizando datos PDF417:", rawData);
            
            try {
                // Eliminar caracteres no imprimibles
                const cleanData = rawData.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                
                // Verificar si los datos est√°n en formato @
                if (cleanData.includes('@')) {
                    const fields = cleanData.split('@');
                    console.log("Campos detectados:", fields);
                    
                    // Mapeo de campos seg√∫n el formato t√≠pico del DNI argentino
                    const data = {
                        apellido: fields[1] || '',
                        nombre: fields[2] || '',
                        numeroDocumento: fields[4] || '',
                        fechaNacimiento: fields[6] || '',
                        sexo: fields[3] || '',
                        domicilio: fields[5] || ''
                    };
                    
                    // Limpiar y formatear los datos
                    Object.keys(data).forEach(key => {
                        if (data[key]) {
                            data[key] = data[key].trim();
                            if (key === 'apellido' || key === 'nombre') {
                                data[key] = formatToTitleCase(data[key]);
                            }
                        }
                    });
                    
                    console.log("Datos procesados:", data);
                    return data;
                }
                
                // Si no est√° en formato @, intentar extraer datos con expresiones regulares
                const data = {
                    apellido: '',
                    nombre: '',
                    numeroDocumento: '',
                    fechaNacimiento: '',
                    sexo: '',
                    domicilio: ''
                };
                
                // Buscar n√∫mero de documento (7-8 d√≠gitos)
                const docMatch = cleanData.match(/\b\d{7,8}\b/);
                if (docMatch) {
                    data.numeroDocumento = docMatch[0];
                }
                
                // Buscar fecha de nacimiento
                const dateMatch = cleanData.match(/\b\d{1,2}[\/-]\d{1,2}[\/-]\d{4}\b/);
                if (dateMatch) {
                    data.fechaNacimiento = dateMatch[0];
                }
                
                // Buscar sexo
                const sexMatch = cleanData.match(/\b(?:SEXO|SEX)\s*[:=]?\s*([MF])\b/i);
                if (sexMatch) {
                    data.sexo = sexMatch[1].toUpperCase();
                }
                
                console.log("Datos extra√≠dos con regex:", data);
                return data;
            } catch (error) {
                console.error("Error al procesar datos PDF417:", error);
                return null;
            }
        }
    </script>
</body>
</html>